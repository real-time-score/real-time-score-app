# 푸시 알림 정책

## 1. 개요

### 1.1 목적
시스템에서 사용자에게 발송하는 푸시 알림의 유형, 발송 조건, 메시지 형식을 정의합니다.

### 1.2 원본 참조
- **PDF 페이지**: 84-85

---

## 2. 푸시 알림 유형

### 2.1 알림 유형 목록

| No | 알림 유형 | 카테고리 | 발송 시점 | 사용자 설정 |
|----|----------|----------|-----------|-------------|
| 1 | 경기 시작 전 알림 | 경기 | 경기 시작 10분 전 | ON/OFF 가능 |
| 2 | 경기 결과 알림 | 경기 | 경기 종료 후 즉시 | ON/OFF 가능 |
| 3 | 예측게임 마감 임박 | 예측 | 마감 1시간 전 | ON/OFF 가능 |
| 4 | 픽 전문가 신규 등록 | 픽전문가 | 등록 즉시 | ON/OFF 가능 |
| 5 | 게시글 인기 상승 중 | 커뮤니티 | 조건 충족 시 | ON/OFF 가능 |
| 6 | 출석 독려 | 출석 | 매일 오후 9시 | ON/OFF 가능 |
| 7 | 안전온도 하락 경고 | 시스템 | 자정 전 | ON/OFF 가능 |
| 8 | 예측 참여 결과 발표 | 예측 | 결과 확정 시 | ON/OFF 가능 |
| 9 | 좋아요·댓글 반응 | 커뮤니티 | 즉시 또는 배치 | ON/OFF 가능 |
| 10 | 랭킹 진입 알림 | 랭킹 | 진입 즉시 | ON/OFF 가능 |
| 11 | 응원메시지 반응 알림 | 커뮤니티 | 반응 발생 시 | ON/OFF 가능 |

---

## 3. 알림 상세 정의

### 3.1 경기 시작 전 알림

| 항목 | 내용 |
|------|------|
| **트리거** | 사용자가 관심 등록한 경기 시작 10분 전 |
| **대상** | 해당 경기를 관심 등록한 사용자 |
| **메시지 예시** | "[토트넘 vs 아스널] 경기가 10분 후 시작됩니다!" |
| **딥링크** | 경기 상세 화면 |

### 3.2 경기 결과 알림

| 항목 | 내용 |
|------|------|
| **트리거** | 관심 등록한 경기 종료 후 |
| **대상** | 해당 경기를 관심 등록한 사용자 |
| **메시지 예시** | "[토트넘 2:1 아스널] 경기가 종료되었습니다. 결과를 확인하세요!" |
| **딥링크** | 경기 상세 화면 |

### 3.3 예측게임 마감 임박

| 항목 | 내용 |
|------|------|
| **트리거** | 예측 게임 마감 1시간 전 |
| **대상** | 예측 게임에 아직 참여하지 않은 사용자 |
| **메시지 예시** | "오늘의 예측게임 마감이 1시간 남았습니다! 지금 참여하세요." |
| **딥링크** | 예측 게임 화면 |

### 3.4 픽 전문가 신규 등록

| 항목 | 내용 |
|------|------|
| **트리거** | 팔로우 중인 전문가가 새 픽 등록 시 |
| **대상** | 해당 전문가를 팔로우 중인 사용자 |
| **메시지 예시** | "[닉네임] 전문가가 새로운 픽을 등록했습니다!" |
| **딥링크** | 픽 상세 화면 |

### 3.5 게시글 인기 상승 중

| 항목 | 내용 |
|------|------|
| **트리거** | 내가 작성한 게시글이 인기 조건 충족 시 |
| **조건** | 좋아요 또는 댓글이 일정 수 이상 증가 |
| **메시지 예시** | "내 게시글이 인기 상승 중입니다! 🔥" |
| **딥링크** | 게시글 상세 화면 |

### 3.6 출석 독려

| 항목 | 내용 |
|------|------|
| **트리거** | 매일 오후 9시 (당일 미출석자) |
| **대상** | 오늘 출석체크를 하지 않은 사용자 |
| **메시지 예시** | "오늘 출석체크를 깜빡하셨나요? 지금 출석하고 포인트 받으세요!" |
| **딥링크** | 출석체크 화면 |

### 3.7 안전온도 하락 경고

| 항목 | 내용 |
|------|------|
| **트리거** | 자정 전, 안전온도가 임계값 이하로 하락 시 |
| **대상** | 안전온도가 낮아진 사용자 |
| **메시지 예시** | "안전온도가 낮아지고 있어요! 활동을 통해 온도를 올려보세요." |
| **딥링크** | 마이페이지 > 안전온도 |

### 3.8 예측 참여 결과 발표

| 항목 | 내용 |
|------|------|
| **트리거** | 참여한 예측 게임의 결과 확정 시 |
| **대상** | 해당 예측에 참여한 사용자 |
| **메시지 예시** | "예측 결과가 발표되었습니다! 적중 여부를 확인하세요." |
| **딥링크** | 예측 결과 화면 |

### 3.9 좋아요·댓글 반응

| 항목 | 내용 |
|------|------|
| **트리거** | 내 게시글/댓글에 좋아요 또는 댓글 발생 시 |
| **발송 방식** | 즉시 발송 또는 일정 시간 배치 발송 |
| **메시지 예시** | "[닉네임]님이 내 게시글에 좋아요를 눌렀습니다." |
| **딥링크** | 해당 게시글/댓글 |

### 3.10 랭킹 진입 알림

| 항목 | 내용 |
|------|------|
| **트리거** | 사용자가 랭킹권에 진입 시 |
| **조건** | TOP 100 진입 등 주요 순위 달성 |
| **메시지 예시** | "축하합니다! TOP 100 랭킹에 진입했습니다! 🎉" |
| **딥링크** | 랭킹 화면 |

### 3.11 응원메시지 반응 알림

| 항목 | 내용 |
|------|------|
| **트리거** | 내 응원메시지에 반응(이모지 등) 발생 시 |
| **대상** | 응원메시지 작성자 |
| **메시지 예시** | "내 응원메시지에 반응이 달렸습니다!" |
| **딥링크** | 응원메시지 화면 |

---

## 4. 푸시 발송 정책

### 4.1 발송 시간 제한

| 정책 | 내용 |
|------|------|
| **심야 시간대 제한** | 22:00 ~ 08:00 발송 제한 (출석 독려 제외) |
| **긴급 알림 예외** | 경기 시작 알림은 시간 제한 없음 |
| **배치 발송** | 좋아요/댓글 반응은 일정 시간 묶어서 발송 가능 |

### 4.2 발송 빈도 제한

| 정책 | 내용 |
|------|------|
| **일일 최대 발송** | 사용자당 일 최대 20건 |
| **동일 유형 제한** | 동일 유형 알림은 최소 30분 간격 |
| **중복 발송 방지** | 동일 컨텐츠에 대한 중복 알림 방지 |

### 4.3 사용자 설정

| 설정 항목 | 기본값 | 설명 |
|----------|--------|------|
| 전체 푸시 ON/OFF | ON | 모든 푸시 알림 제어 |
| 경기 알림 | ON | 경기 시작/결과 알림 |
| 예측 알림 | ON | 예측 게임 관련 알림 |
| 픽전문가 알림 | ON | 팔로우 전문가 새 픽 알림 |
| 커뮤니티 알림 | ON | 좋아요/댓글/인기 알림 |
| 출석 알림 | ON | 출석 독려 알림 |
| 시스템 알림 | ON | 안전온도, 랭킹 등 시스템 알림 |
| 마케팅 알림 | OFF | 이벤트, 프로모션 알림 |

---

## 5. 데이터 요구사항

### 5.1 푸시 알림 데이터

```typescript
interface PushNotification {
  id: string;                    // 알림 고유 ID
  type: PushNotificationType;    // 알림 유형
  userId: string;                // 수신자 ID
  title: string;                 // 알림 제목
  body: string;                  // 알림 내용
  data: {
    deepLink: string;            // 딥링크 URL
    referenceId?: string;        // 참조 ID (경기ID, 게시글ID 등)
    referenceType?: string;      // 참조 타입
  };
  status: 'pending' | 'sent' | 'failed' | 'clicked';
  sentAt?: Date;                 // 발송 시간
  clickedAt?: Date;              // 클릭 시간
  createdAt: Date;
}

enum PushNotificationType {
  MATCH_START = 'MATCH_START',           // 경기 시작 전
  MATCH_RESULT = 'MATCH_RESULT',         // 경기 결과
  PREDICTION_DEADLINE = 'PREDICTION_DEADLINE',  // 예측 마감 임박
  NEW_PICK = 'NEW_PICK',                 // 픽 전문가 신규 등록
  POST_POPULAR = 'POST_POPULAR',         // 게시글 인기 상승
  ATTENDANCE = 'ATTENDANCE',             // 출석 독려
  SAFETY_TEMP = 'SAFETY_TEMP',           // 안전온도 하락
  PREDICTION_RESULT = 'PREDICTION_RESULT', // 예측 결과 발표
  REACTION = 'REACTION',                 // 좋아요/댓글 반응
  RANKING = 'RANKING',                   // 랭킹 진입
  CHEER_REACTION = 'CHEER_REACTION',     // 응원메시지 반응
  MARKETING = 'MARKETING'                // 마케팅 알림
}
```

### 5.2 사용자 푸시 설정 데이터

```typescript
interface UserPushSettings {
  userId: string;
  globalEnabled: boolean;        // 전체 푸시 ON/OFF
  matchEnabled: boolean;         // 경기 알림
  predictionEnabled: boolean;    // 예측 알림
  pickExpertEnabled: boolean;    // 픽전문가 알림
  communityEnabled: boolean;     // 커뮤니티 알림
  attendanceEnabled: boolean;    // 출석 알림
  systemEnabled: boolean;        // 시스템 알림
  marketingEnabled: boolean;     // 마케팅 알림
  updatedAt: Date;
}
```

---

## 6. API 요구사항

### 6.1 API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/push/settings` | 사용자 푸시 설정 조회 |
| PUT | `/api/push/settings` | 사용자 푸시 설정 수정 |
| GET | `/api/push/history` | 푸시 알림 히스토리 조회 |
| POST | `/api/push/read` | 푸시 알림 읽음 처리 |
| POST | `/api/admin/push/send` | [Admin] 푸시 발송 |
| GET | `/api/admin/push/statistics` | [Admin] 푸시 통계 조회 |

### 6.2 API 스키마

#### 푸시 설정 조회/수정

```typescript
// GET /api/push/settings
// Response
{
  globalEnabled: boolean;
  matchEnabled: boolean;
  predictionEnabled: boolean;
  pickExpertEnabled: boolean;
  communityEnabled: boolean;
  attendanceEnabled: boolean;
  systemEnabled: boolean;
  marketingEnabled: boolean;
}

// PUT /api/push/settings
// Request
{
  globalEnabled?: boolean;
  matchEnabled?: boolean;
  predictionEnabled?: boolean;
  pickExpertEnabled?: boolean;
  communityEnabled?: boolean;
  attendanceEnabled?: boolean;
  systemEnabled?: boolean;
  marketingEnabled?: boolean;
}
```

#### 푸시 히스토리 조회

```typescript
// GET /api/push/history?page=1&limit=20
// Response
{
  items: [
    {
      id: string;
      type: PushNotificationType;
      title: string;
      body: string;
      deepLink: string;
      isRead: boolean;
      sentAt: Date;
    }
  ];
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

---

## 7. 관리자 기능

### 7.1 푸시 관리 기능

| 기능 | 설명 |
|------|------|
| 푸시 발송 | 대상자 선택 후 수동 푸시 발송 |
| 예약 발송 | 특정 시간에 푸시 예약 발송 |
| 발송 이력 조회 | 푸시 발송 이력 및 상태 확인 |
| 통계 대시보드 | 발송률, 클릭률, 유형별 통계 |
| 템플릿 관리 | 자주 사용하는 푸시 템플릿 관리 |

### 7.2 푸시 통계 항목

| 통계 항목 | 설명 |
|----------|------|
| 일별 발송 건수 | 일자별 푸시 발송 총 건수 |
| 유형별 발송 건수 | 알림 유형별 발송 통계 |
| 발송 성공률 | 성공/실패 비율 |
| 클릭률 (CTR) | 발송 대비 클릭 비율 |
| 시간대별 클릭률 | 시간대별 사용자 반응률 |
| 사용자 설정 현황 | 알림 설정 ON/OFF 비율 |

### 7.3 관리자 화면 요구사항

```
📁 Admin 푸시 관리
├── 푸시 발송
│   ├── 대상 선택 (전체/조건별/개별)
│   ├── 메시지 작성
│   ├── 딥링크 설정
│   ├── 즉시/예약 발송 선택
│   └── 발송 확인 및 실행
├── 발송 이력
│   ├── 발송 목록 (필터: 날짜, 유형, 상태)
│   ├── 발송 상세 (수신자, 상태, 클릭 여부)
│   └── 재발송 기능
├── 템플릿 관리
│   ├── 템플릿 목록
│   ├── 템플릿 생성/수정/삭제
│   └── 변수 치환 설정
└── 통계
    ├── 일별/주별/월별 발송 통계
    ├── 유형별 통계
    ├── 클릭률 분석
    └── 사용자 설정 현황
```

---

## 8. 기술 요구사항

### 8.1 푸시 서비스

| 항목 | 요구사항 |
|------|----------|
| **iOS** | APNs (Apple Push Notification service) |
| **Android** | FCM (Firebase Cloud Messaging) |
| **토큰 관리** | 디바이스 토큰 등록/갱신/삭제 |
| **다중 디바이스** | 사용자당 복수 디바이스 지원 |

### 8.2 푸시 발송 프로세스

```
1. 트리거 발생 (이벤트/스케줄)
     ↓
2. 대상자 필터링
   - 알림 설정 확인
   - 발송 제한 규칙 확인
     ↓
3. 메시지 생성
   - 템플릿 적용
   - 변수 치환
     ↓
4. 발송 요청
   - FCM/APNs 호출
     ↓
5. 결과 저장
   - 성공/실패 상태 기록
     ↓
6. 히스토리 저장
   - 사용자 알림함 저장
```

---

## 9. 체크리스트

### 9.1 구현 체크리스트

- [ ] FCM/APNs 연동
- [ ] 디바이스 토큰 관리 API
- [ ] 푸시 설정 API
- [ ] 푸시 발송 서비스
- [ ] 스케줄러 (출석 독려 등)
- [ ] 푸시 히스토리 저장
- [ ] Admin 푸시 관리 화면
- [ ] 푸시 통계 대시보드

### 9.2 확인 필요 사항

- [ ] 심야 시간대 발송 제한 정확한 시간
- [ ] 배치 발송 간격 (좋아요/댓글)
- [ ] 마케팅 푸시 법적 동의 절차
- [ ] 일일 최대 발송 건수 최종 확정

---

## 10. 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0 | 2025-12-22 | 초기 문서 작성 |
